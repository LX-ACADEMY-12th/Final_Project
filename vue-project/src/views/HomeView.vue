<template>
  <div class="d-flex flex-column h-100 bg-white" style="font-family: 'SUIT', sans-serif">

    <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-white"
      style="flex-shrink: 0; position: sticky; top: 0; z-index: 1020;">
      <div style="width: 24px; height: 24px;"></div>
      <h2 class="h5 mb-0 fw-bold">êµê³¼ì„œ</h2>
      <button class="btn p-0 border-0 d-flex flex-column align-items-center" style="font-size: 0.75rem; color: #4A7CEC;"
        @click="goToAiTutor">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-robot"
          viewBox="0 0 16 16">
          <path
            d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5M3 8.062C3 6.76 4.235 5.765 5.53 5.5S8.1 6.656 8.1 8.062v0a.5.5 0 0 1-.5.5H3.5a.5.5 0 0 1-.5-.5m9.03 0v-.001C12.03 6.76 10.794 5.765 9.5 5.5S6.93 6.656 6.93 8.062v0a.5.5 0 0 1-.5.5h4.1a.5.5 0 0 1-.5-.5" />
          <path
            d="M0 11.5A1.5 1.5 0 0 1 1.5 10h13A1.5 1.5 0 0 1 16 11.5v2A1.5 1.5 0 0 1 14.5 15h-13A1.5 1.5 0 0 1 0 13.5zM1.5 11a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5h13a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 0-.5-.5zM2 12.5a.5.5 0 0 1 .5-.5h.09a.5.5 0 0 1 0 1H2.5a.5.5 0 0 1-.5-.5m3.5 0a.5.5 0 0 1 .5-.5h.09a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5m3.5 0a.5.5 0 0 1 .5-.5h.09a.5.5 0 0 1 0 1H9.5a.5.5 0 0 1-.5-.5m3.5 0a.5.5 0 0 1 .5-.5h.09a.5.5 0 0 1 0 1H13a.5.5 0 0 1-.5-.5" />
        </svg>
        AIíŠœí„°
      </button>
    </div>

    <div class="flex-grow-1" style="overflow-y: auto; min-height: 0;">

      <div class="p-3">
        <div class="d-flex align-items-center gap-3 p-3 rounded-4 shadow-sm"
          style="background-color: #4A7CEC; color: white;">

          <!-- í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•  ì›í˜• ì»¨í…Œì´ë„ˆì…ë‹ˆë‹¤.
            'overflow: hidden;'ì„ ì¶”ê°€í•˜ì—¬ ì´ë¯¸ì§€ê°€ ì› ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. -->
          <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0" style="
          width: 48px;
          height: 48px;
          background-color: rgba(255, 255, 255, 0.3);
          overflow: hidden;
        ">
            <!--
          v-if:
          ìŠ¤í† ì–´ì˜ user ê°ì²´ì— profileImageUrlì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°(nullì´ë‚˜ undefinedê°€ ì•„ë‹Œ ê²½ìš°),
          ë°±ì—”ë“œë¡œë¶€í„° ë°›ì€ 'Signed URL'ì„ src ì†ì„±ì— ë°”ì¸ë”©í•˜ì—¬ <img> íƒœê·¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.-->
            <img v-if="user?.profileImageUrl" :src="user.profileImageUrl" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" style="
            width: 100%;
            height: 100%;
            object-fit: cover;
          " />
            <!--
          v-else:
          user.profileImageUrlì´ ì—†ëŠ” ê²½ìš°(ì‹ ê·œ ê°€ì…ì ë˜ëŠ” ì´ë¯¸ì§€ ë¯¸ë“±ë¡ì),
          ê¸°ì¡´ì˜ ê¸°ë³¸ SVG ì•„ì´ì½˜ì„ í‘œì‹œí•©ë‹ˆë‹¤.
          -->
            <svg v-else xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white" class="bi bi-person-fill"
              viewBox="0 0 16 16">
              <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zM8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6" />
            </svg>
          </div>
          <div class="flex-grow-1">
            <div class="fw-bold fs-6">ì•ˆë…•í•˜ì„¸ìš”</div>
            <div class="fw-bold fs-5">{{ userName }}</div>
          </div>
        </div>
      </div>

      <div class="p-3">
        <p class="text-secondary" style="font-size: 0.9rem;">í•™ë…„ì„ ì„ íƒí•˜ë©´ ì½˜í…ì¸ ê°€ ê²Œì‹œë©ë‹ˆë‹¤.</p>
        <div class="fs-5 flex-wrap"> <span>ìš°ë¦¬ ì•„ì´ëŠ” </span>
          <a href="#" class="text-decoration-none fw-bold" style="color: #4A7CEC;" @click.prevent="isModalOpen = true">
            {{ selectedSubject }}
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
              class="bi bi-chevron-down" viewBox="0 0 16 16">
              <path fill-rule="evenodd"
                d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />
            </svg>
          </a>
          <span>ê°€ ê¶ê¸ˆí•œ </span>
          <a href="#" class="text-decoration-none fw-bold" style="color: #4A7CEC;" @click.prevent="isModalOpen = true">
            {{ selectedGrade }}
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
              class="bi bi-chevron-down" viewBox="0 0 16 16">
              <path fill-rule="evenodd"
                d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708" />
            </svg>
          </a>
          <span>ì…ë‹ˆë‹¤.</span>
        </div>
      </div>

      <div class="p-3">
        <div class="rounded-3 shadow-sm" style="background-color: #8B5A2B; padding: 10px; border-radius: 12px;">
          <div style="background-color: #2E4F2F; min-height: 180px; border-radius: 8px; position: relative;"
            class="p-3 chalkboard-text">

            <div v-for="(semesterData, index) in chalkboardContent" :key="semesterData.semester"
              :class="{ 'mt-3': index > 0 }">
              <h6 class="fw-bold chalkboard-heading">{{ semesterData.semester }}</h6>
              <ul v-if="semesterData.units.length > 0" class="chalkboard-list">
                <li v-for="unit in semesterData.units" :key="unit">{{ unit }}</li>
              </ul>
              <p v-else class="chalkboard-no-data">í•´ë‹¹ í•™ê¸°ì— ì—°ê´€ëœ ë‹¨ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>

            <div class="position-absolute w-100"
              style="background-color: #D2B48C; height: 20px; bottom: -20px; left: 0; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;">
              <div class="position-absolute"
                style="background-color: #fff; width: 30px; height: 10px; bottom: 5px; right: 20px; border-radius: 2px;">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center p-3 mt-3">
        <h5 class="fw-bold fs-6 mb-3">ì¶”ì²œ í•™ìŠµ ì¥ì†Œ</h5>
      </div>

      <div class="d-flex gap-2 px-3">
        <button type="button" class="spec-button shadow-sm flex-grow-1" :class="{ 'active': selectedTab === 'ì „ì‹œ' }"
          @click="selectedTab = 'ì „ì‹œ'">ì „ì‹œ</button>
        <button type="button" class="spec-button shadow-sm flex-grow-1" :class="{ 'active': selectedTab === 'íƒí—˜' }"
          @click="selectedTab = 'íƒí—˜'">íƒí—˜</button>
      </div>

      <div class="mt-3" style="height: 450px;">
        <div style="width: 100%; max-width: 100%; overflow-x: auto; overflow-y: hidden; height: 100%;">
          <div class="d-flex flex-row align-items-start px-3" style="gap: 16px; height: 100%;">

            <PlaceReviewCard v-for="item in carouselItems" :key="item.id" :item="item" @add="goToDetail(item)" />

          </div>
        </div>
      </div>

      <div class="p-3 mt-3">
        <h5 class="fw-bold fs-6 mb-3">ìµœê·¼ ì €ì¥ ê²½ë¡œ</h5>
      </div>
      <div class="px-3">
        <div class="rounded-4 overflow-hidden shadow-sm">
          <img src="https://via.placeholder.com/390x150/e9e9e0/aaa?text=Map+Image" class="img-fluid" alt="Map">
        </div>
      </div>
      <div class="p-3 mt-3">
        <div class="d-flex align-items-center p-3 bg-white rounded-4 shadow-sm gap-3">
          <img src="https://via.placeholder.com/80/e9e9e0/aaa?text=Map" class="rounded-3"
            style="width: 80px; height: 80px; flex-shrink: 0;">
          <div class="flex-grow-1">
            <span class="badge rounded-pill" style="background-color: #E0F1FF; color: #007AFF;">ì§€êµ¬</span>
            <h5 class="fw-bold m-0 mt-2">ì „ì‹œëª…</h5>
            <span class="text-secondary" style="font-size: 0.9rem;">êµ­ë¦½ê³¼ì²œê³¼í•™ê´€</span>
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="red" class="bi bi-heart-fill fs-4"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314" />
          </svg>
        </div>
      </div>

      <div style="height: 80px;"></div>

    </div>

    <BottomNavbar :selectedNavItem="selectedNavItem" @navigate="handleNavigation" style="flex-shrink: 0;" />

    <FilterModal v-if="isModalOpen" :initialSubject="selectedSubject" :initialGrade="selectedGrade"
      @close="isModalOpen = false" @complete="handleFilterComplete" :showLocationOptions="false" />

  </div>
</template>

<script>
import { ref, computed } from 'vue';
import { useRouter } from 'vue-router';
import { useAuthStore } from '@/stores/authStore';
import { storeToRefs } from 'pinia';

// ì»´í¬ë„ŒíŠ¸ ì„í¬íŠ¸
import FilterModal from '@/components/modal/FilterModal.vue';
import BottomNavbar from '@/components/BottomNavbar.vue';
import PlaceReviewCard from '@/components/card/PlaceReviewCard.vue';


export default {
  components: {
    FilterModal,
    BottomNavbar,
    PlaceReviewCard
  },

  setup() {
    const authStore = useAuthStore();
    const { user } = storeToRefs(authStore);
    // ğŸŸ¢ user ìƒíƒœì— ë”°ë¼ í™”ë©´ì— í‘œì‹œí•  ì´ë¦„ì„ ê³„ì‚°í•˜ëŠ” computed ì†ì„±
    const userName = computed(() => {
      // user.valueì— ì •ë³´ê°€ ìˆê³  nameì´ ìˆë‹¤ë©´ 'OOO í•™ë¶€ëª¨ë‹˜' í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
      if (user.value?.name) {
        return `${user.value.name} í•™ë¶€ëª¨ë‹˜`;
      }
      // user ì •ë³´ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€ ë°˜í™˜
      return 'ë¡œê·¸ì¸ í•„ìš”';
    });

    const router = useRouter();
    const selectedTab = ref('ì „ì‹œ');
    const isModalOpen = ref(false);
    const selectedSubject = ref('ë¬¼ë¦¬');
    const selectedGrade = ref('ì´ˆë“± 3í•™ë…„'); // [ìˆ˜ì •] 'ì´ˆë“±í•™ìƒ' -> 'ì´ˆë“± 3í•™ë…„'
    const selectedNavItem = ref('í™ˆ');

    const curriculumData = {
      'ì´ˆë“± 3í•™ë…„': {
        '1í•™ê¸°': {
          'ë¬¼ë¦¬': ['í˜ê³¼ ìš°ë¦¬ ìƒí™œ'],
          'í™”í•™': [],
          'ìƒëª…': ['ë™ë¬¼ì˜ ìƒí™œ', 'ì‹ë¬¼ì˜ ìƒí™œ', 'ìƒë¬¼ì˜ í•œì‚´ì´'],
          'ì§€êµ¬': []
        },
        '2í•™ê¸°': {
          'ë¬¼ë¦¬': ['ì†Œë¦¬ì˜ ì„±ì§ˆ'],
          'í™”í•™': ['ë¬¼ì§ˆì˜ ì„±ì§ˆ'],
          'ìƒëª…': [],
          'ì§€êµ¬': ['ì§€êµ¬ì™€ ë°”ë‹¤']
        }
      },
      'ì´ˆë“± 4í•™ë…„': {
        '1í•™ê¸°': {
          'ë¬¼ë¦¬': ['ìì„ì˜ ì´ìš©'],
          'í™”í•™': ['ë¬¼ì˜ ìƒíƒœ ë³€í™”'],
          'ìƒëª…': ['ë‹¤ì–‘í•œ ìƒë¬¼ê³¼ ìš°ë¦¬ ìƒí™œ'],
          'ì§€êµ¬': ['ë•…ì˜ ë³€í™”']
        },
        '2í•™ê¸°': {
          'ë¬¼ë¦¬': [],
          'í™”í•™': ['ê¸°ì²´ì˜ ì„±ì§ˆ'],
          'ìƒëª…': ['ìƒë¬¼ê³¼ í™˜ê²½'],
          'ì§€êµ¬': ['ë°¤í•˜ëŠ˜ ê´€ì°°', 'ê¸°í›„ë³€í™”ì™€ ìš°ë¦¬ ìƒí™œ']
        }
      },
      'ì´ˆë“± 5í•™ë…„': {
        '1í•™ê¸°': {
          'ë¬¼ë¦¬': ['ë¹›ì˜ ì„±ì§ˆ'],
          'í™”í•™': ['ìš©í•´ì™€ ìš©ì•¡'],
          'ìƒëª…': ['ìš°ë¦¬ ëª¸ì˜ êµ¬ì¡°ì˜ ê¸°ëŠ¥'],
          'ì§€êµ¬': ['ì§€ì¸µê³¼ í™”ì„']
        },
        '2í•™ê¸°': {
          'ë¬¼ë¦¬': ['ì—´ê³¼ ìš°ë¦¬ ìƒí™œ', 'ìì›ê³¼ ì—ë„ˆì§€'],
          'í™”í•™': ['í˜¼í•©ë¬¼ì˜ ë¶„ë¦¬'],
          'ìƒëª…': [],
          'ì§€êµ¬': ['ë‚ ì”¨ì™€ ìš°ë¦¬ ìƒí™œ']
        }
      },
      'ì´ˆë“± 6í•™ë…„': {
        '1í•™ê¸°': {
          'ë¬¼ë¦¬': ['ë¬¼ì²´ì˜ ìš´ë™'],
          'í™”í•™': ['ì‚°ê³¼ ì—¼ê¸°'],
          'ìƒëª…': ['ì‹ë¬¼ì˜ êµ¬ì¡°ì™€ ê¸°ëŠ¥'],
          'ì§€êµ¬': ['ì§€êµ¬ì˜ ìš´ë™']
        },
        '2í•™ê¸°': {
          'ë¬¼ë¦¬': ['ì „ê¸°ì˜ ì´ìš©'],
          'í™”í•™': ['ë¬¼ì§ˆì˜ ë³€í™”'],
          'ìƒëª…': [],
          'ì§€êµ¬': ['ê³„ì ˆì˜ ë³€í™”']
        }
      }
    };

    const carouselItems = ref([
      { id: 1, subject: 'ì§€êµ¬', grade: 'ì´ˆë“± 3í•™ë…„', place: 'ì¥ì†Œëª…', type: 'ì „ì‹œ', title: 'ì „ì‹œëª…', },
      { id: 2, subject: 'ë¬¼ë¦¬', grade: 'ì´ˆë“± 5í•™ë…„', place: 'ì„œìš¸ì²œë¬¸ëŒ€', type: 'íƒí—˜', title: 'ì²œë¬¸ëŒ€íƒí—˜' },
      { id: 3, subject: 'í™”í•™', grade: 'ì´ˆë“± 4í•™ë…„', place: 'í•œì²œê°•ì§€ì§ˆê³µì›', type: 'íƒí—˜', title: 'ì§€ì§ˆíƒí—˜' }
    ]);

    const chalkboardContent = computed(() => {
      let gradeKey = selectedGrade.value;
      // [ìˆ˜ì •] 'ì´ˆë“±í•™ìƒ'ì¼ ê²½ìš° 'ì´ˆë“± 3í•™ë…„'ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë¡œì§ ìœ ì§€
      if (!['ì´ˆë“± 3í•™ë…„', 'ì´ˆë“± 4í•™ë…„', 'ì´ˆë“± 5í•™ë…„', 'ì´ˆë“± 6í•™ë…„'].includes(gradeKey)) {
        gradeKey = 'ì´ˆë“± 3í•™ë…„';
      }

      const subjectKey = selectedSubject.value;

      const gradeData = curriculumData[gradeKey];
      if (!gradeData) {
        return [{ semester: 'ë°ì´í„° ì—†ìŒ', units: [] }];
      }

      const semester1Units = gradeData['1í•™ê¸°'][subjectKey] || [];
      const semester2Units = gradeData['2í•™ê¸°'][subjectKey] || [];

      return [
        {
          semester: `${gradeKey} 1í•™ê¸° - ${subjectKey}`,
          units: semester1Units
        },
        {
          semester: `${gradeKey} 2í•™ê¸° - ${subjectKey}`,
          units: semester2Units
        }
      ];
    });

    const goToDetail = (item) => {
      console.log(`ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™:`, item.title);
      router.push('/place/:id')
    }

    const handleFilterComplete = (filterData) => {
      console.log(`í•„í„° ì„ íƒ ì™„ë£Œ:`, filterData);
      selectedSubject.value = filterData.subject;
      selectedGrade.value = filterData.grade;
      isModalOpen.value = false;
    }

    const handleNavigation = (navItemName) => {
      console.log(navItemName, 'í´ë¦­ë¨.');
      selectedNavItem.value = navItemName;

      if (navItemName === 'í™ˆ') {
        router.push('/home');
      } else if (navItemName === 'ëª©ë¡') {
        router.push('/list');
      } else if (navItemName === 'ì§€ë„') {
        router.push('/map');
      } else if (navItemName === 'ì½”ìŠ¤ê´€ë¦¬') {
        router.push('/usercourselist');
      } else if (navItemName === 'ë§ˆì´í˜ì´ì§€') {
        router.push('/mypage');
      }
    }

    const goToAiTutor = () => {
      router.push('/aitutor');
    }

    return {
      user,
      userName,
      selectedTab,
      isModalOpen,
      selectedSubject,
      selectedGrade,
      selectedNavItem,
      carouselItems,
      goToDetail,
      handleFilterComplete,
      handleNavigation,
      goToAiTutor,
      chalkboardContent
    };
  }
}
</script>

<style scoped>
/* (ê¸°ì¡´ ìŠ¤íƒ€ì¼ ... ) */
[style*="font-family: 'SUIT'"] {
  font-family: 'SUIT', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.spec-button {
  display: flex;
  flex-direction: row;
  justify-content: center;
  align-items: center;
  padding: 5px 16px;
  gap: 8px;
  position: relative;
  height: 38px;
  border-radius: 20px;
  background: #FFFFFF;
  color: #333;
  border: 1px solid #ddd;
  transition: background-color 0.2s, color 0.2s;
  font-family: 'SUIT', sans-serif;
  font-weight: 500;
}

.spec-button.active {
  background: #4A7CEC;
  color: white;
  border: none;
  font-weight: 700;
}

.flex-grow-1[style*="overflow-y: auto"] {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

[style*="overflow-x: auto"] {
  box-sizing: border-box;
}

/* --- [ìˆ˜ì •] ì¹ íŒ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ --- */
.chalkboard-text {
  color: #f0f0f0;
}

.chalkboard-heading {
  color: #fff;
  font-size: 1rem;
  font-weight: 700;
}

.chalkboard-list {
  list-style-type: none;
  padding-left: 1.25rem;
  font-size: 0.9rem;
}

.chalkboard-list li {
  position: relative;
  margin-bottom: 0.35rem;
  color: #ffffff;
}

.chalkboard-list li::before {
  content: '';
  position: absolute;
  left: -1.25rem;
  top: 50%;
  transform: translateY(-50%);
  width: 10px;
  height: 10px;
  background-color: #ffffff;
  border-radius: 50%;
}

.chalkboard-no-data {
  font-size: 0.9rem;
  color: #888;
  padding-left: 1.25rem;
}
</style>
