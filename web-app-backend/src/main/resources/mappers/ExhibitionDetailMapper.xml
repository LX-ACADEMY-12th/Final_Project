<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.ExhibitionDetailMapper">

    <select id="findExhibitionById" resultType="com.example.demo.dto.ExhibitionDetailDTO">
        SELECT
            eh.hall_id,
            eh.hall_name AS exhibitionHallName,
            eh.description,
            eh.main_image_url,
            eh.latitude,
            eh.longitude,
            eh.start_date,
            eh.end_date,
            eh.opening_hours,
            eh.admission_fee,
            eh.average_rating,
            eh.total_reviews,
            STRING_AGG(DISTINCT e.exhibition_name, '||') AS exhibitionListStr,
            (
                SELECT
                    COUNT(p.photo_id)
                FROM review r
                         JOIN review_photo p ON r.review_id = p.review_id
                WHERE
                    r.target_id = eh.hall_id
                  AND r.target_type = 'exhibition'
            ) AS totalPhotoReviews,
            -- 방문 인증 로직 추가
            (
                CASE
                    -- userId가 없으면 (비로그인) 무조건 false
                    WHEN #{userId, jdbcType=BIGINT} IS NULL THEN false
                    -- userId가 있으면, STAMP_RECORD 테이블에 기록이 존재하는지(EXISTS) 확인
                    ELSE EXISTS (
                        SELECT 1
                        FROM STAMP_RECORD sr
                        WHERE sr.user_id = #{userId}
                          AND sr.target_id = eh.hall_id
                          AND sr.target_type = 'exhibition'
                    )
                    END
                ) AS visited,
            -- 찜 관련 로직
            (
                CASE
                    -- 1. userId가 없으면 (비로그인) 무조건 false
                    WHEN #{userId, jdbcType=BIGINT} IS NULL THEN false
                    -- 2. userId가 있으면, 찜(wishlist) 테이블에 기록이 존재하는지(EXISTS) 확인
                    ELSE EXISTS (
                        SELECT 1
                        FROM wishlist wl  -- :뒤쪽_화살표::뒤쪽_화살표: 찜 테이블명 (예: 'wishlist')
                        WHERE wl.user_id = #{userId}
                          AND wl.target_id = eh.hall_id
                          AND wl.target_type = 'exhibition'
                    )
                    END
                ) AS liked,
            -- 위치 정보
            CONCAT_WS(' ', eh.science_center_name, eh.hall_name) AS location
        FROM
            exhibition_hall AS eh
                LEFT JOIN
            exhibition AS e ON e.hall_id = eh.hall_id
                LEFT JOIN
            exhibition_curriculum_mapping AS ecm ON e.exhibition_id = ecm.exhibition_id
                LEFT JOIN
            curriculum_sub_category AS csc ON ecm.sub_category_id = csc.sub_category_id
                LEFT JOIN
            curriculum_main_category AS cmc ON csc.main_category_id = cmc.main_category_id
                LEFT JOIN
            exhibition_grade_mapping AS ecm_grade ON e.exhibition_id = ecm_grade.exhibition_id
                LEFT JOIN
            grade_category gc ON ecm_grade.grade_id = gc.grade_id
        WHERE
            eh.hall_id = #{exhibitionHallId}
        GROUP BY
            eh.hall_id,
            eh.hall_name,
            eh.description,
            eh.main_image_url,
            eh.latitude,
            eh.longitude,
            eh.start_date,
            eh.end_date,
            eh.opening_hours,
            eh.admission_fee,
            eh.average_rating,
            eh.total_reviews,
            eh.science_center_name;
    </select>

    <select id="findHallCoordinates" parameterType="long"
            resultType="com.example.demo.dto.ExhibitionDetailDTO">
        SELECT
            latitude,
            longitude
        FROM
            exhibition_hall
        WHERE
            hall_id = #{hallId}
    </select>

</mapper>