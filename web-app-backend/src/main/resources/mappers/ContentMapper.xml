<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ContentMapper">
    <resultMap id="ContentResultMap" type="com.example.demo.dto.ContentResultDTO">
        <id property="id" column="contentId"/>
        <result property="imageUrl" column="imageUrl"/>
        <result property="title" column="title"/>
        <result property="exhibitionLists" column="exhibitionLists"
                jdbcType="ARRAY"
                javaType="java.util.List"
                typeHandler="com.example.demo.typehandler.StringListTypeHandler"/>
        <result property="subject" column="categoryName" />
        <result property="hashtags" column="subCategoryName"
                jdbcType="ARRAY"
                javaType="java.util.List"
                typeHandler="com.example.demo.typehandler.StringListTypeHandler" />
        <result property="type" column="type"/>
        <result property="place" column="place"/>
        <result property="lat" column="lat"/>
        <result property="lng" column="lng"/>
        <result property="grade" column="gradeName"/>
        <result property="itemType" column="itemType" />
    </resultMap>

    <!-- 콘텐츠 일반 필터  -->
    <select id="findContentByFilter" resultMap="ContentResultMap">
        SELECT
            eh.hall_id as contentId,
            eh.main_image_url as imageUrl,
            eh.hall_name as title,
            ARRAY_AGG(DISTINCT e.exhibition_name) AS exhibitionLists,
            cmc.category_name AS categoryName,
            ARRAY_AGG(DISTINCT csc.sub_category_name) AS subCategoryName,
            e.type as type,
            eh.science_center_name AS place,
            eh.latitude AS lat,
            eh.longitude AS lng,
            #{grade} AS gradeName,
            'exhibition' AS itemType
        FROM exhibition_hall AS eh
                 -- 전시관이랑 전시 조인
                 JOIN exhibition AS e ON e.hall_id = eh.hall_id
                 JOIN exhibition_curriculum_mapping AS ecm ON ecm.exhibition_id = e.exhibition_id
                 JOIN curriculum_sub_category AS csc ON csc.sub_category_id = ecm.sub_category_id
                 JOIN curriculum_main_category AS cmc ON cmc.main_category_id = csc.main_category_id
                 JOIN grade_category AS gc ON gc.grade_id = csc.grade_id
        WHERE
            cmc.category_name = #{subject}
          AND gc.grade_name LIKE '%' || #{grade} || '%'
        GROUP BY
            eh.hall_id,
            e.type,
            cmc.category_name
        UNION ALL
        SELECT
            sp.place_id as contentId,
            sp.main_image_url as imageUrl,
            sp.place_name as title,
            NULL AS exhibitionLists,
            cmc.category_name AS categoryName,
            ARRAY_AGG(DISTINCT csc.sub_category_name) AS subCategoryName,
            sp.place_type as type,
            sp.address_detail AS place,
            sp.latitude AS lat,
            sp.longitude AS lng,
            #{grade} AS gradeName,
            'science_place' AS itemType
        FROM science_place AS sp
                 JOIN place_curriculum_mapping AS pcm ON pcm.place_id = sp.place_id
                 JOIN curriculum_sub_category AS csc ON csc.sub_category_id = pcm.sub_category_id
                 JOIN curriculum_main_category AS cmc ON cmc.main_category_id = csc.main_category_id
                 JOIN grade_category AS gc ON gc.grade_id = csc.grade_id
        WHERE
            cmc.category_name = #{subject}
          AND gc.grade_name LIKE '%' || #{grade} || '%'
        GROUP BY
            sp.place_id,
            sp.place_type,
            cmc.category_name;
    </select>

    <!-- 콘텐츠 반경 필터  -->
    <select id="findContentByRadius" resultMap="ContentResultMap">
        SELECT
            eh.hall_id as contentId,
            eh.main_image_url as imageUrl,
            eh.hall_name as title,
            ARRAY_AGG(DISTINCT e.exhibition_name) AS exhibitionLists,
            cmc.category_name AS categoryName,
            ARRAY_AGG(DISTINCT csc.sub_category_name) AS subCategoryName,
            e.type as type,
            eh.science_center_name AS place,
            eh.latitude AS lat,
            eh.longitude AS lng,
            #{grade} AS gradeName,
            'exhibition' AS itemType,
            -- 거리 계산 (km 단위)
            (ST_Distance(
                     eh.geog,
                     ST_SetSRID(ST_MakePoint(#{lng}, #{lat}), 4326)::geography
             ) / 1000.0) AS distance_km
        FROM exhibition_hall AS eh
                 JOIN exhibition AS e ON e.hall_id = eh.hall_id
                 JOIN exhibition_curriculum_mapping AS ecm ON ecm.exhibition_id = e.exhibition_id
                 JOIN curriculum_sub_category AS csc ON csc.sub_category_id = ecm.sub_category_id
                 JOIN curriculum_main_category AS cmc ON cmc.main_category_id = csc.main_category_id
                 JOIN grade_category AS gc ON gc.grade_id = csc.grade_id
        WHERE
            cmc.category_name = #{subject}
          AND gc.grade_name LIKE '%' || #{grade} || '%'
          -- [!!] 전시관(eh.geog) 기준으로 반경 필터 적용
          AND ST_DWithin(
                eh.geog,
                ST_SetSRID(ST_MakePoint(#{lng}, #{lat}), 4326)::geography,
                #{radius} * 1000  -- km를 미터(m)로 변환
              )
        GROUP BY
            eh.hall_id,
            e.type,
            cmc.category_name,
            eh.geog  -- ST_Distance를 사용했으므로 GROUP BY에 geog 추가

        UNION ALL

        SELECT
            sp.place_id as contentId,
            sp.main_image_url as imageUrl,
            sp.place_name as title,
            NULL AS exhibitionLists,
            cmc.category_name AS categoryName,
            ARRAY_AGG(DISTINCT csc.sub_category_name) AS subCategoryName,
            sp.place_type as type,
            sp.address_detail AS place,
            sp.latitude AS lat,
            sp.longitude AS lng,
            #{grade} AS gradeName,
            'science_place' AS itemType,
            -- 거리 계산 (km 단위)
            (ST_Distance(
                     sp.geog,
                     ST_SetSRID(ST_MakePoint(#{lng}, #{lat}), 4326)::geography
             ) / 1000.0) AS distance_km
        FROM science_place AS sp
                 JOIN place_curriculum_mapping AS pcm ON pcm.place_id = sp.place_id
                 JOIN curriculum_sub_category AS csc ON csc.sub_category_id = pcm.sub_category_id
                 JOIN curriculum_main_category AS cmc ON cmc.main_category_id = csc.main_category_id
                 JOIN grade_category AS gc ON gc.grade_id = csc.grade_id
        WHERE
            cmc.category_name = #{subject}
          AND gc.grade_name LIKE '%' || #{grade} || '%'
          -- [!!] 과학 장소(sp.geog) 기준으로 반경 필터 적용
          AND ST_DWithin(
                sp.geog,
                ST_SetSRID(ST_MakePoint(#{lng}, #{lat}), 4326)::geography,
                #{radius} * 1000  -- km를 미터(m)로 변환
              )
        GROUP BY
            sp.place_id,
            sp.place_type,
            cmc.category_name,
            sp.geog  -- ST_Distance를 사용했으므로 GROUP BY에 geog 추가

        ORDER BY
            distance_km ASC;
    </select>

    <!-- AI 추천 전시관 코스를 위한 후보군 추출   -->
    <resultMap id="innerCourseItemResultMap" type="com.example.demo.dto.CourseHallDTO">
        <result property="hallId"     column="hall_id"/>
        <result property="hallName"   column="hall_name"/>
        <result property="relevantExhibitionCount"   column="relevant_exhibition_count"/>
        <result property="subCategories"   column="sub_categories"
                jdbcType="ARRAY"
                javaType="java.util.List"
                typeHandler="com.example.demo.typehandler.StringListTypeHandler"/>
        <result property="relevantExhibitions"   column="relevant_exhibitions_names"
                jdbcType="ARRAY"
                javaType="java.util.List"
                typeHandler="com.example.demo.typehandler.StringListTypeHandler"/>
        <result property="combinedDescriptions"   column="combined_descriptions"/>
        <result property="distanceMeters" column="distance_meters" />
    </resultMap>
    <select id="findSimilarExhibition" resultMap="innerCourseItemResultMap">
        WITH TargetGeom AS (
            SELECT geog
            FROM exhibition_hall
            WHERE hall_id = #{currentId}
        )
        SELECT
            eh.hall_id,
            eh.hall_name,
            COUNT(DISTINCT e.exhibition_id) AS relevant_exhibition_count,
            ARRAY_AGG(DISTINCT csc.sub_category_name) AS sub_categories,
            ARRAY_AGG(DISTINCT e.exhibition_name) AS relevant_exhibition_names,
            STRING_AGG(e.description, ' | ') AS combined_descriptions,
            ST_Distance(eh.geog, (SELECT geog FROM TargetGeom)) AS distance_meters
        FROM
            exhibition_hall AS eh
                JOIN exhibition AS e ON e.hall_id = eh.hall_id
                JOIN exhibition_curriculum_mapping AS ecm ON ecm.exhibition_id = e.exhibition_id
                JOIN curriculum_sub_category AS csc ON csc.sub_category_id = ecm.sub_category_id
                JOIN curriculum_main_category AS cmc ON cmc.main_category_id = csc.main_category_id
                JOIN grade_category AS gc ON gc.grade_id = csc.grade_id
        WHERE
            -- 1. 현재 위치 제외
            eh.hall_id != #{currentId}
    AND
    -- 2. 사용자의 관심사와 일치
    gc.grade_name = #{grade}
    AND
    cmc.category_name = #{mainCategory}
    AND
    -- 3. 전시관 위치 근방 (예: 1000m 이내)
    ST_DWithin(eh.geog, (SELECT geog FROM TargetGeom), 1000)
        GROUP BY
            eh.hall_id, eh.hall_name, eh.geog
        ORDER BY
            distance_meters ASC -- 가까운 순서대로 정렬 (AI에게 1차 정렬된 후보를 줌)
            LIMIT 5;
    </select>

    <!-- AI가 추천한 전시관 ID와 기타 정보로 전시관 정보 가져오기    -->
    <resultMap id="CourseResultMap" type="com.example.demo.dto.CourseItemDTO">
        <id property="placeId" column="placeId"/>
        <result property="placeName" column="placeName"/>
        <result property="subjectName" column="subjectName"/>
        <result property="gradeName" column="gradeName"/>
        <result property="description" column="description"/>
        <result property="imageUrl" column="imageUrl"/>
        <result property="address" column="address"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="placeType" column="placeType"/>

        <result property="hashtags" column="hashtags"
                jdbcType="ARRAY"
                javaType="java.util.List"
                typeHandler="com.example.demo.typehandler.StringListTypeHandler"/>
        <result property="exhibitionList" column="exhibitionList"
                jdbcType="ARRAY"
                javaType="java.util.List"
                typeHandler="com.example.demo.typehandler.StringListTypeHandler"/>
    </resultMap>
    <select id="findExhibitionsByHallIdAndCriteria" resultMap="CourseResultMap">
        SELECT
            eh.hall_id AS placeId,
            eh.hall_name AS placeName,
            cmc.category_name AS subjectName,
            gc.grade_name AS gradeName,
            eh.description,
            'exhibition' AS placeType,
            eh.main_image_url AS imageUrl,
            eh.address_detail AS address,
            eh.latitude,
            eh.longitude,
            ARRAY_AGG(DISTINCT csc.sub_category_name) AS hashtags,
            ARRAY_AGG(DISTINCT e.exhibition_name) AS exhibitionList
        FROM
            exhibition_hall AS eh
                JOIN exhibition AS e ON e.hall_id = eh.hall_id
                JOIN exhibition_curriculum_mapping AS ecm ON ecm.exhibition_id = e.exhibition_id
                JOIN curriculum_sub_category AS csc ON csc.sub_category_id = ecm.sub_category_id
                JOIN curriculum_main_category AS cmc ON cmc.main_category_id = csc.main_category_id
                JOIN grade_category AS gc ON gc.grade_id = csc.grade_id
        WHERE
            eh.hall_id = #{hallId}
          AND cmc.category_name = #{mainCategory}
          AND gc.grade_name = #{grade}
        GROUP BY
            eh.hall_id, cmc.category_name, gc.grade_name;
    </select>

    <!-- AI 추천 과학장소 코스를 위한 후보군 추출   -->
    <resultMap id="outerCourseItemResultMap" type="com.example.demo.dto.CourseItemDTO">
        <id property="placeId" column="place_id"/>
        <result property="placeName" column="place_name"/>
        <result property="subjectName" column="subjectName"/>
        <result property="gradeName" column="gradeName"/>
        <result property="description" column="description"/>
        <result property="imageUrl" column="imageUrl"/>
        <result property="address" column="address"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="placeType" column="placeType"/>

        <result property="hashtags" column="hashtags"
                jdbcType="ARRAY"
                javaType="java.util.List"
                typeHandler="com.example.demo.typehandler.StringListTypeHandler"/>
    </resultMap>
    <select id="findSimilarSciencePlace" resultMap="outerCourseItemResultMap">
        WITH TargetGeom AS (
            SELECT geog
            FROM science_place
            WHERE place_id = #{currentId}
        )
        SELECT
            sp.place_id,
            sp.place_name,
            ARRAY_AGG(DISTINCT csc.sub_category_name) AS hashtags,
            ST_Distance(sp.geog, (SELECT geog FROM TargetGeom)) AS distance_meters,
            sp.description
        FROM
            science_place AS sp
                JOIN place_curriculum_mapping AS pcm ON pcm.place_id = sp.place_id
                JOIN curriculum_sub_category AS csc ON csc.sub_category_id = pcm.sub_category_id
                JOIN curriculum_main_category AS cmc ON cmc.main_category_id = csc.main_category_id
                JOIN grade_category AS gc ON gc.grade_id = csc.grade_id
        WHERE
            -- 1. 현재 위치 제외
            sp.place_id != #{currentId}
            AND
            -- 2. 사용자의 관심사와 일치
            gc.grade_name = #{grade}
            AND
            cmc.category_name = #{mainCategory}
            AND
        -- 3. 과학장소 위치 근방 (예: 30000m 이내)
        ST_DWithin(sp.geog, (SELECT geog FROM TargetGeom), 30000)
        GROUP BY
            sp.place_id, sp.place_name, sp.geog
        ORDER BY
            distance_meters ASC -- 가까운 순서대로 정렬 (AI에게 1차 정렬된 후보를 줌)
            LIMIT 5;
    </select>

    <!-- AI가 추천한 과학장소 ID와 기타 정보로 과학장소 정보 가져오기   -->
    <select id="findSciencePlaceByPlaceIdAndCriteria" resultMap="outerCourseItemResultMap">
    SELECT
        sp.place_id AS place_id,
        sp.place_name AS place_name,
        cmc.category_name AS subjectName,
        gc.grade_name AS gradeName,
        sp.description,
        'science_place' AS placeType,
        sp.main_image_url AS imageUrl,
        sp.address_detail AS address,
        sp.latitude,
        sp.longitude,
        ARRAY_AGG(DISTINCT csc.sub_category_name) AS hashtags
    FROM
        science_place AS sp
        JOIN place_curriculum_mapping AS pcm ON pcm.place_id = sp.place_id
        JOIN curriculum_sub_category AS csc ON csc.sub_category_id = pcm.sub_category_id
        JOIN curriculum_main_category AS cmc ON cmc.main_category_id = csc.main_category_id
        JOIN grade_category AS gc ON gc.grade_id = csc.grade_id
    WHERE
        sp.place_id = #{placeId}
        AND cmc.category_name = #{mainCategory}
        AND gc.grade_name = #{grade}
    GROUP BY
        sp.place_id, cmc.category_name, gc.grade_name;
    </select>

    <select id="findPlacesForLikedList" resultType="com.example.demo.dto.LikedCourseListDTO">
        SELECT place_id, place_name
        FROM science_place
        WHERE place_id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
    <resultMap id="SciencePlaceResult" type="com.example.demo.vo.SciencePlace">
        <id property="id" column="place_id"/>
        <result property="placeName" column="place_name"/>
        <result property="description" column="description"/>
        <result property="mainImageUrl" column="main_image_url"/>
        <result property="addressDetail" column="address_detail"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="admissionFee" column="admission_fee"/>
        <result property="openingHours" column="opening_hours"/>
    </resultMap>
    <select id="findById" parameterType="long" resultMap="SciencePlaceResult">
        SELECT * FROM science_place WHERE place_id = #{id}
    </select>
    <insert id="insert" parameterType="com.example.demo.vo.SciencePlace" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO science_place (
            place_name, description, main_image_url, address_detail,
            latitude, longitude, admission_fee, opening_hours
        ) VALUES (
                     #{placeName}, #{description}, #{mainImageUrl}, #{addressDetail},
                     #{latitude}, #{longitude}, #{admissionFee}, #{openingHours}
                 )
    </insert>
    <update id="update" parameterType="com.example.demo.vo.SciencePlace">
        UPDATE science_place
        SET
            place_name = #{placeName},
            description = #{description},
            main_image_url = #{mainImageUrl},
            address_detail = #{addressDetail},
            latitude = #{latitude},
            longitude = #{longitude},
            admission_fee = #{admissionFee},
            opening_hours = #{openingHours}
        WHERE place_id = #{id}
    </update>
    <delete id="deleteById" parameterType="long">
        DELETE FROM science_place WHERE place_id = #{id}
    </delete>
    <select id="findAllForAdmin" resultMap="PlaceResultMap">
    SELECT
        sp.place_id as id,
        sp.place_name as title,
        'PLACE' as type,
        MIN(cmc.category_name) as subject,
        MIN(gc.grade_name) as grade,
        sp.address_detail as place,
        sp.main_image_url as imageUrl
    FROM science_place sp
        LEFT JOIN place_curriculum_mapping pcm ON sp.place_id = pcm.place_id
        LEFT JOIN curriculum_sub_category csc ON pcm.sub_category_id = csc.sub_category_id
        LEFT JOIN curriculum_main_category cmc ON csc.main_category_id = cmc.main_category_id
        LEFT JOIN grade_category gc ON csc.grade_id = gc.grade_id
    GROUP BY
        sp.place_id
    ORDER BY
        sp.place_id DESC
    </select>



</mapper>