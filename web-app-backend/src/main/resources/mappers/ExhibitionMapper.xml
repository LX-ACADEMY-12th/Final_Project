<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.demo.mapper.ExhibitionMapper">

    <select id="findAllExhibitions" resultType="com.example.demo.dto.ExhibitionDTO">
        SELECT 
            exhibition_id,
            exhibition_name,
            description,
            image_file_name
        FROM 
            exhibition
        
        <where>
            <if test="category != null and category != ''">
                AND image_file_name LIKE CONCAT(#{category}, '/%')
            </if>
        </where>
        
        ORDER BY 
            exhibition_id ASC
    </select>

    <!-- 관리자 대시보드 -->
    <select id="findExhibitionsForLikedList" resultType="com.example.demo.dto.LikedCourseListDTO">
        SELECT exhibition_id, exhibition_name
        FROM exhibition
        WHERE exhibition_id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
    <resultMap id="ExhibitionResult" type="com.example.demo.vo.Exhibition">
        <id property="id" column="exhibition_id"/>
        <result property="exhibitionName" column="exhibition_name"/>
        <result property="hallId" column="hall_id"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="type" column="type"/>
        <result property="startDate" column="start_date"/>
        <result property="endDate" column="end_date"/>
        <result property="admissionFee" column="admission_fee"/>
        <result property="openingHours" column="opening_hours"/>
        <result property="mainImageUrl" column="main_image_url"/>
        <result property="description" column="description"/>
    </resultMap>
    <select id="findById" parameterType="long" resultMap="ExhibitionResult">
        SELECT * FROM exhibition WHERE exhibition_id = #{id}
    </select>
    <insert id="insert" parameterType="com.example.demo.vo.Exhibition" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO exhibition (
            exhibition_name, hall_id, latitude, longitude, type, start_date,
            end_date, admission_fee, opening_hours, main_image_url, description
        ) VALUES (
                     #{exhibitionName}, #{hallId}, #{latitude}, #{longitude}, #{type}, #{startDate},
                     #{endDate}, #{admissionFee}, #{openingHours}, #{mainImageUrl}, #{description}
                 )
    </insert>
    <update id="update" parameterType="com.example.demo.vo.Exhibition">
        UPDATE exhibition
        SET
            exhibition_name = #{exhibitionName},
            hall_id = #{hallId},
            latitude = #{latitude},
            longitude = #{longitude},
            type = #{type},
            start_date = #{startDate},
            end_date = #{endDate},
            admission_fee = #{admissionFee},
            opening_hours = #{openingHours},
            main_image_url = #{mainImageUrl},
            description = #{description}
        WHERE exhibition_id = #{id}
    </update>
    <delete id="deleteById" parameterType="long">
        DELETE FROM exhibition WHERE exhibition_id = #{id}
    </delete>
    <resultMap id="AdminPlaceResultMap" type="com.example.demo.dto.PlaceResultDTO">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="subject" column="subject"/>
        <result property="grade" column="grade"/>
        <result property="place" column="place"/>
        <result property="imageUrl" column="imageUrl"/>
        <result property="type" column="type"/>
    </resultMap>
    <select id="findAllForAdmin" resultMap="AdminPlaceResultMap">
        SELECT
            e.exhibition_id as id,
            e.exhibition_name as title,
            e.type as type,
            MIN(cmc.category_name) as subject,
            MIN(gc.grade_name) as grade,
            eh.hall_name as place,
            e.main_image_url as imageUrl
        FROM exhibition e
                 LEFT JOIN exhibition_hall eh ON e.hall_id = eh.hall_id
                 LEFT JOIN exhibition_curriculum_mapping ecm ON e.exhibition_id = ecm.exhibition_id
                 LEFT JOIN curriculum_sub_category csc ON ecm.sub_category_id = csc.sub_category_id
                 LEFT JOIN curriculum_main_category cmc ON csc.main_category_id = cmc.main_category_id
                 LEFT JOIN grade_category gc ON csc.grade_id = gc.grade_id
        GROUP BY
            e.exhibition_id, eh.hall_name
        ORDER BY
            e.exhibition_id DESC
    </select>
    <select id="findCombinedAdminContent"
            resultMap="com.example.demo.mapper.ContentMapper.PlaceResultMap"
            parameterType="map">
        (
            SELECT
                e.exhibition_id as id,
                e.exhibition_name as title,
                MIN(cmc.category_name) as subject,
                MIN(gc.grade_name) as grade,
                eh.hall_name as place,
                e.main_image_url as imageUrl,
                NULL as hashtags,          e.latitude as lat,         e.longitude as lng,        e.type as type
            FROM exhibition e
                     LEFT JOIN exhibition_hall eh ON e.hall_id = eh.hall_id
                     LEFT JOIN exhibition_curriculum_mapping ecm ON e.exhibition_id = ecm.exhibition_id
                     LEFT JOIN curriculum_sub_category csc ON ecm.sub_category_id = csc.sub_category_id
                     LEFT JOIN curriculum_main_category cmc ON csc.main_category_id = cmc.main_category_id
                     LEFT JOIN grade_category gc ON csc.grade_id = gc.grade_id
            GROUP BY
                e.exhibition_id, eh.hall_name
        )
        UNION ALL
        (
            SELECT
                sp.place_id as id,
                sp.place_name as title,
                MIN(cmc.category_name) as subject,
                MIN(gc.grade_name) as grade,
                sp.address_detail as place,
                sp.main_image_url as imageUrl,
                NULL as hashtags,           sp.latitude as lat,         sp.longitude as lng,        'PLACE' as type
            FROM science_place sp
                     LEFT JOIN place_curriculum_mapping pcm ON sp.place_id = pcm.place_id
                     LEFT JOIN curriculum_sub_category csc ON pcm.sub_category_id = csc.sub_category_id
                     LEFT JOIN curriculum_main_category cmc ON csc.main_category_id = cmc.main_category_id
                     LEFT JOIN grade_category gc ON csc.grade_id = gc.grade_id
            GROUP BY
                sp.place_id
        )
        ORDER BY id DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>
    <select id="countCombinedAdminContent" resultType="int">
        SELECT COUNT(*) FROM (
                                 (
                                     SELECT e.exhibition_id
                                     FROM exhibition e
                                              LEFT JOIN exhibition_hall eh ON e.hall_id = eh.hall_id
                                              LEFT JOIN exhibition_curriculum_mapping ecm ON e.exhibition_id = ecm.exhibition_id
                                              LEFT JOIN curriculum_sub_category csc ON ecm.sub_category_id = csc.sub_category_id
                                              LEFT JOIN curriculum_main_category cmc ON csc.main_category_id = cmc.main_category_id
                                              LEFT JOIN grade_category gc ON csc.grade_id = gc.grade_id
                                     GROUP BY e.exhibition_id, eh.hall_name
                                 )
                                 UNION ALL
                                 (
                                     SELECT sp.place_id
                                     FROM science_place sp
                                              LEFT JOIN place_curriculum_mapping pcm ON sp.place_id = pcm.place_id
                                              LEFT JOIN curriculum_sub_category csc ON pcm.sub_category_id = csc.sub_category_id
                                              LEFT JOIN curriculum_main_category cmc ON csc.main_category_id = cmc.main_category_id
                                              LEFT JOIN grade_category gc ON csc.grade_id = gc.grade_id
                                     GROUP BY sp.place_id
                                 )
                             ) AS TotalCount
    </select>


    <resultMap id="hallDetailResultMap" type="com.example.demo.dto.HallDetailResultDTO">
        <result property="hallId" column="hall_id"/>
        <result property="scienceCenterId" column="science_center_id"/>
        <result property="exhibitionLocation" column="exhibition_location"/>
        <result property="floors" column="floors"/>
        <result property="lat" column="lat"/>
        <result property="lng" column="lng"/>
        <result property="operationPeriod" column="operation_period"/>
        <result property="operationHours" column="operation_hours"/>
        <result property="entranceFee" column="entrance_fee"/>
    </resultMap>

    <resultMap id="hallSimpleResultMap" type="com.example.demo.dto.HallSimpleResultDTO">
        <result property="key" column="key"/>
        <result property="name" column="hall_name"/>
        <result property="locationDescription" column="location_description"/>
        <result property="floors" column="floors"/>
    </resultMap>

    <select id="findHallDetailById" parameterType="long" resultMap="hallDetailResultMap">
        SELECT
            h.hall_id AS hall_id,
            split_part(h.science_center_name, ' ', 1) AS science_center_id,
            h.name AS exhibition_location,
            h.floors,
            s.lat, s.lng, s.operation_period, s.operation_hours, s.entrance_fee
        FROM
            exhibition_hall h
                JOIN
            science_center s ON split_part(h.science_center_name, ' ', 1) = s.name
        WHERE
            h.hall_id = #{hallId}
    </select>

    <select id="findHallsByScienceCenterName" parameterType="string" resultMap="hallSimpleResultMap">
        SELECT
            h.hall_id AS key,
            h.hall_name,
            h.description AS location_description
        FROM
            exhibition_hall h
        WHERE
            split_part(h.science_center_name, ' ', 1) = #{scienceCenterName}
        ORDER BY
            h.hall_name
    </select>

</mapper>