<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.WishListMapper">

	<!-- wishlist Ï∂îÍ∞Ä -->
	<insert id="addWishlist">
	    INSERT INTO wishlist (user_id, target_type, target_id, category_name, grade_name)
	    VALUES (#{userId}, #{targetType}, #{targetId}, #{mainCategory}, #{gradeTag})
	    ON CONFLICT (user_id, target_id, target_type) DO NOTHING
	</insert>
	
	<!-- wishlist Ï∑®ÏÜå -->
	<delete id="removeWishlist">
	    DELETE FROM wishlist
	    WHERE user_id = #{userId}
	      AND target_id = #{targetId}
	</delete>
	
	<!-- ÏÇ¨Ïö©ÏûêÏùò Ï∞ú Ïó¨Î∂Ä ÌôïÏù∏ -->
	<select id="existsInWishlist" resultType="boolean">
	    SELECT EXISTS (
	        SELECT 1
	        FROM wishlist
	        WHERE user_id = #{userId}
	          AND target_type = #{targetType}
	          AND target_id = #{targetId}
	    )
	</select>

    <resultMap id="wishlistResultMap"
               type="com.example.demo.dto.WishListResponseDTO"
               autoMapping="true">

        <result property="subCategories"
                column="subCategories"
                typeHandler="com.example.demo.typehandler.StringListTypeHandler"/>
    </resultMap>

	<!-- ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∞úÏùÑ ÎàÑÎ•∏ ÏúÑÏãúÎ¶¨Ïä§Ìä∏Î•º Ï°∞Ìöå -->
    <select id="findMyWishlistByUserId" resultMap="wishlistResultMap">
        (
            -- [ÌååÌä∏ 1: Ï†ÑÏãú Ï∞ú Î™©Î°ù]
            SELECT
                w.wishlist_id AS wishlistId,
                w.target_type AS targetType,
                w.target_id AS targetId,
                w.category_name AS mainCategory,
                w.grade_name AS gradeTag,
                e.exhibition_name AS title,
                e.main_image_url AS mainImageUrl,
                e.average_rating AS averageRating,
                e.total_reviews AS totalReviews,
                ARRAY_REMOVE(ARRAY_AGG(DISTINCT csc.sub_category_name), NULL) AS subCategories,
                w.created_at AS likedAt,
                e.type AS type,
                CONCAT_WS(' ', h.science_center_name, h.hall_name) AS place
            FROM wishlist w
                     JOIN exhibition e ON w.target_id = e.exhibition_id
                     LEFT JOIN exhibition_hall h ON e.hall_id = h.hall_id
                     LEFT JOIN exhibition_curriculum_mapping ecm ON e.exhibition_id = ecm.exhibition_id
                     LEFT JOIN curriculum_main_category cmc ON cmc.category_name = w.category_name
                     LEFT JOIN curriculum_sub_category csc ON csc.main_category_id = cmc.main_category_id
            WHERE w.user_id = #{userId}
              AND w.target_type = 'exhibition'
            GROUP BY
                w.wishlist_id,
                w.target_type,
                w.target_id,
                w.category_name,
                w.grade_name,
                e.exhibition_id,
                e.exhibition_name,
                e.main_image_url,
                e.average_rating,
                e.total_reviews,
                w.created_at,
                e.type,
                h.science_center_name,
                h.hall_name
        ) -- üëà [ÏàòÏ†ï] ÏÑ∏ÎØ∏ÏΩúÎ°†(;) ÏÇ≠Ï†ú

        UNION ALL

        -- [ÌååÌä∏ 2: Í≥ºÌïô Ïû•ÏÜå Ï∞ú Î™©Î°ù]
        (
            SELECT
                w.wishlist_id AS wishlistId,
                w.target_type AS targetType,
                w.target_id AS targetId,
                w.category_name AS mainCategory,
                w.grade_name AS gradeTag,
                sp.place_name AS title,
                sp.main_image_url AS mainImageUrl,
                sp.average_rating AS averageRating,
                sp.total_reviews AS totalReviews,
                ARRAY_REMOVE(ARRAY_AGG(DISTINCT csc.sub_category_name), NULL) AS subCategories,
                w.created_at AS likedAt,
                sp.place_type AS type,
                sp.address_detail AS place
            FROM wishlist w
                     JOIN science_place sp ON w.target_id = sp.place_id
                     LEFT JOIN place_curriculum_mapping pcm ON sp.place_id = pcm.place_id
                     LEFT JOIN curriculum_main_category cmc ON cmc.category_name = w.category_name
                     LEFT JOIN curriculum_sub_category csc ON csc.main_category_id = cmc.main_category_id
            WHERE w.user_id = #{userId}
              AND w.target_type = 'science_place'
            GROUP BY
                w.wishlist_id,
                w.target_type,
                w.target_id,
                w.category_name,  -- üëà [ÏàòÏ†ï] ÎàÑÎùΩÎêú Ïª¨Îüº Ï∂îÍ∞Ä
                w.grade_name,     -- üëà [ÏàòÏ†ï] ÎàÑÎùΩÎêú Ïª¨Îüº Ï∂îÍ∞Ä
                sp.place_id,
                sp.place_name,
                sp.main_image_url,
                sp.average_rating,
                sp.total_reviews,
                w.created_at,
                sp.place_type,
                sp.address_detail
        )
        -- [Ï†ïÎ†¨] Ìï©Ï≥êÏßÑ Ï†ÑÏ≤¥ Í≤∞Í≥ºÎ•º Ï∞úÌïú ÎÇ†Ïßú ÏµúÏã†ÏàúÏúºÎ°ú Ï†ïÎ†¨
        ORDER BY
            likedAt DESC
    </select>
	
	
</mapper>