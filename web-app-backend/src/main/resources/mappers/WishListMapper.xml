<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.demo.mapper.WishListMapper">

	<!-- wishlist ì¶”ê°€ -->
	<insert id="addWishlist">
	    INSERT INTO wishlist (user_id, target_type, target_id, category_name, grade_name)
	    VALUES (#{userId}, #{targetType}, #{targetId}, #{mainCategory}, #{gradeTag})
	    ON CONFLICT (user_id, target_id, target_type) DO NOTHING
	</insert>
	
	<!-- wishlist ì·¨ì†Œ -->
	<delete id="removeWishlist">
	    DELETE FROM wishlist
	    WHERE user_id = #{userId}
	      AND target_id = #{targetId}
	</delete>
	
	<!-- ì‚¬ìš©ìì˜ ì°œ ì—¬ë¶€ í™•ì¸ -->
	<select id="existsInWishlist" resultType="boolean">
	    SELECT EXISTS (
	        SELECT 1
	        FROM wishlist
	        WHERE user_id = #{userId}
	          AND target_type = #{targetType}
	          AND target_id = #{targetId}
	    )
	</select>

	<!-- ì‚¬ìš©ìê°€ ì°œì„ ëˆ„ë¥¸ ìœ„ì‹œë¦¬ìŠ¤íŠ¸ë¥¼ ì¡°íšŒ -->
    <select id="findMyWishlistByUserId" resultType="com.example.demo.dto.WishListResponseDTO">
        (
            -- [íŒŒíŠ¸ 1: ì „ì‹œ ì°œ ëª©ë¡]
            SELECT
                w.wishlist_id AS wishlistId,
                w.target_type AS targetType,
                w.target_id AS targetId,
                w.category_name AS mainCategory,
                w.grade_name AS gradeTag,
                e.exhibition_name AS title,
                e.main_image_url AS mainImageUrl,
                e.average_rating AS averageRating,
                e.total_reviews AS totalReviews,
                ARRAY_AGG(DISTINCT csc.sub_category_name) AS subCategories,
                w.created_at AS likedAt,
                e.type AS type,
                CONCAT_WS(' ', h.science_center_name, h.hall_name) AS place
            FROM wishlist w
                     JOIN exhibition e ON w.target_id = e.exhibition_id
                     LEFT JOIN exhibition_hall h ON e.hall_id = h.hall_id
                     LEFT JOIN exhibition_curriculum_mapping ecm ON e.exhibition_id = ecm.exhibition_id
                     LEFT JOIN curriculum_main_category cmc ON cmc.category_name = w.category_name
                     LEFT JOIN curriculum_sub_category csc ON csc.main_category_id = cmc.main_category_id
            WHERE w.user_id = #{userId}
              AND w.target_type = 'exhibition'
            GROUP BY
                w.wishlist_id,
                w.target_type,
                w.target_id,
                w.category_name,
                w.grade_name,
                e.exhibition_id,
                e.exhibition_name,
                e.main_image_url,
                e.average_rating,
                e.total_reviews,
                w.created_at,
                e.type,
                h.science_center_name,
                h.hall_name
        ) -- ğŸ‘ˆ [ìˆ˜ì •] ì„¸ë¯¸ì½œë¡ (;) ì‚­ì œ

        UNION ALL

        -- [íŒŒíŠ¸ 2: ê³¼í•™ ì¥ì†Œ ì°œ ëª©ë¡]
        (
            SELECT
                w.wishlist_id AS wishlistId,
                w.target_type AS targetType,
                w.target_id AS targetId,
                w.category_name AS mainCategory,
                w.grade_name AS gradeTag,
                sp.place_name AS title,
                sp.main_image_url AS mainImageUrl,
                sp.average_rating AS averageRating,
                sp.total_reviews AS totalReviews,
                ARRAY_AGG(DISTINCT csc.sub_category_name) AS subCategories,
                w.created_at AS likedAt,
                sp.place_type AS type,
                sp.address_detail AS place
            FROM wishlist w
                     JOIN science_place sp ON w.target_id = sp.place_id
                     LEFT JOIN place_curriculum_mapping pcm ON sp.place_id = pcm.place_id
                     LEFT JOIN curriculum_main_category cmc ON cmc.category_name = w.category_name
                     LEFT JOIN curriculum_sub_category csc ON csc.main_category_id = cmc.main_category_id
            WHERE w.user_id = #{userId}
              AND w.target_type = 'science_place'
            GROUP BY
                w.wishlist_id,
                w.target_type,
                w.target_id,
                w.category_name,  -- ğŸ‘ˆ [ìˆ˜ì •] ëˆ„ë½ëœ ì»¬ëŸ¼ ì¶”ê°€
                w.grade_name,     -- ğŸ‘ˆ [ìˆ˜ì •] ëˆ„ë½ëœ ì»¬ëŸ¼ ì¶”ê°€
                sp.place_id,
                sp.place_name,
                sp.main_image_url,
                sp.average_rating,
                sp.total_reviews,
                w.created_at,
                sp.place_type,
                sp.address_detail
        ) -- ğŸ‘ˆ [ìˆ˜ì •] ì„¸ë¯¸ì½œë¡ (;) ì‚­ì œ

        -- [ì •ë ¬] í•©ì³ì§„ ì „ì²´ ê²°ê³¼ë¥¼ ì°œí•œ ë‚ ì§œ ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
        ORDER BY
            likedAt DESC
        -- ğŸ‘ˆ [ìˆ˜ì •] ë§ˆì§€ë§‰ ì„¸ë¯¸ì½œë¡ (;)ë„ ì œê±°
    </select>
	
	
</mapper>